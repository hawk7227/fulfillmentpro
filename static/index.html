<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FulfillmentPro">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>FulfillmentPro Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { max-width: 100%; overflow-x: hidden; margin: 0; padding: 0; }
        body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .stat-box { background: white; border-radius: 10px; padding: 8px 10px; border: 2px solid #e2e8f0; }
        .clickable { cursor: pointer; transition: transform 0.1s; }
        .clickable:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <!-- Push Notification Permission Popup -->
<div id="push-permission-popup" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full border-4 border-indigo-500 overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-center">
            <div class="text-6xl mb-3">üîî</div>
            <h2 class="text-2xl font-black text-white mb-2">Enable Push Notifications</h2>
            <p class="text-white/90 font-bold">Stay updated on orders in real-time</p>
        </div>
        <div class="p-6">
            <div class="space-y-3 mb-6">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center border-2 border-green-300">
                        <span class="text-xl">üõí</span>
                    </div>
                    <div>
                        <div class="font-black text-gray-800">New Order Alerts</div>
                        <div class="text-gray-500 text-sm">Get notified instantly</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-xl bg-yellow-100 flex items-center justify-center border-2 border-yellow-300">
                        <span class="text-xl">üîê</span>
                    </div>
                    <div>
                        <div class="font-black text-gray-800">Manual Verification</div>
                        <div class="text-gray-500 text-sm">When login required</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center border-2 border-blue-300">
                        <span class="text-xl">‚úÖ</span>
                    </div>
                    <div>
                        <div class="font-black text-gray-800">Success Updates</div>
                        <div class="text-gray-500 text-sm">Order confirmations</div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="enablePushNotifications()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-black py-3 px-6 rounded-xl transition">
                    ‚úÖ Enable
                </button>
                <button onclick="dismissPushPermission()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-black py-3 px-6 rounded-xl transition">
                    Later
                </button>
            </div>
        </div>
    </div>
</div>
    <!-- Header -->
    <header class="bg-white shadow-md border-b-2 border-indigo-600">
        <div class="px-3 py-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <span class="text-sm">üì¶</span>
                    </div>
                    <div>
                        <h1 class="text-xs font-black text-gray-800">FulfillmentPro</h1>
                        <span class="text-[6px] font-black text-white bg-gradient-to-r from-indigo-500 to-purple-500 px-1.5 py-0.5 rounded-full">LIVE</span>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="refreshData()" class="p-1.5 bg-gray-100 rounded-lg border border-gray-300">
                        <span class="text-sm">üîÑ</span>
                    </button>
                    <div id="status-indicator" class="flex items-center gap-1 bg-green-100 px-1.5 py-1 rounded-lg border border-green-400">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full pulse"></span>
                        <span class="font-black text-green-700 text-[8px]">ONLINE</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="px-2">
            <div class="flex gap-1 py-1.5 overflow-x-auto">
                <button onclick="showPage('orders')" class="nav-btn active px-2 py-1 rounded-lg font-bold text-[9px] whitespace-nowrap" data-page="orders">üìã Orders</button>
                <button onclick="showPage('detail')" class="nav-btn px-2 py-1 rounded-lg font-bold text-[9px] whitespace-nowrap" data-page="detail">üîç Detail</button>
                <button onclick="showPage('verification')" class="nav-btn px-2 py-1 rounded-lg font-bold text-[9px] whitespace-nowrap relative" data-page="verification">
                    ‚ö†Ô∏è Verify
                    <span id="verify-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 text-white text-[6px] font-black rounded-full items-center justify-center hidden">0</span>
                </button>
                <button onclick="showPage('mapping')" class="nav-btn px-2 py-1 rounded-lg font-bold text-[9px] whitespace-nowrap relative" data-page="mapping">
                üó∫Ô∏è Map
                <span id="mapping-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 text-white text-[6px] font-black rounded-full items-center justify-center hidden">0</span>
            </button>
                <button onclick="showPage('monitor')" class="nav-btn px-2 py-1 rounded-lg font-bold text-[9px] whitespace-nowrap" data-page="monitor">üìä Monitor</button>
            </div>
        </div>
    </nav>

    <main class="px-3 py-3">
        <!-- ORDERS PAGE -->
        <div id="page-orders" class="page active">
            <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 rounded-xl p-3 mb-3">
                <div class="flex justify-between items-center">
                    <div class="text-white">
                        <h2 class="text-base font-black">üìã Orders Dashboard</h2>
                        <p class="text-white/80 font-bold text-[9px]">Shopify automation system</p>
                    </div>
                </div>
            </div>

            <div id="stats-container" class="flex flex-col gap-2 mb-3">
                <div class="stat-box border-indigo-400 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center"><span class="text-xs">üì¶</span></div>
                        <span class="text-gray-500 font-black text-[10px]">TOTAL ORDERS</span>
                    </div>
                    <span class="text-lg font-black text-gray-800" id="stat-total">0</span>
                </div>
                <div class="stat-box border-green-400 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center"><span class="text-xs">‚úÖ</span></div>
                        <span class="text-gray-500 font-black text-[10px]">COMPLETED</span>
                    </div>
                    <span class="text-lg font-black text-green-500" id="stat-completed">0</span>
                </div>
                <div class="stat-box border-orange-400 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-orange-400 to-yellow-500 flex items-center justify-center"><span class="text-xs">‚è≥</span></div>
                        <span class="text-gray-500 font-black text-[10px]">QUEUE</span>
                    </div>
                    <span class="text-lg font-black text-orange-500" id="stat-queue">0</span>
                </div>
            </div>

            <div class="bg-white rounded-xl border-2 border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-3 py-2">
                    <h3 class="text-white font-black text-xs">üìú Recent Orders</h3>
                </div>
                <div id="orders-list" class="divide-y divide-gray-200">
                    <div class="p-3 text-center text-gray-500 text-[9px]">Loading...</div>
                </div>
            </div>
        </div>

        <!-- DETAIL PAGE -->
        <div id="page-detail" class="page">
            <button onclick="showPage('orders')" class="text-indigo-600 font-bold text-[10px] mb-2">‚Üê Back</button>
            <div id="detail-content">
                <div class="text-center text-gray-500 py-8"><p class="text-sm">Select an order to view details</p></div>
            </div>
        </div>

        <!-- VERIFICATION PAGE -->
        <div id="page-verification" class="page">
            <div class="bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 rounded-xl p-3 mb-3">
                <h2 class="text-base font-black text-white">‚ö†Ô∏è Manual Verification</h2>
                <p class="text-white/80 font-bold text-[9px]">Tasks requiring your attention</p>
            </div>
            <div id="verification-list">
                <div class="p-3 text-center text-gray-500 text-[9px]">Loading...</div>
            </div>
        </div>
        <!-- MAPPING PAGE -->
<div id="page-mapping" class="page">
    <div class="bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500 rounded-xl p-3 mb-3">
        <h2 class="text-base font-black text-white">üó∫Ô∏è Product Mapping</h2>
        <p class="text-white/80 font-bold text-[9px]">ASINs not in catalog</p>
    </div>
    <div id="mapping-list">
        <div class="p-3 text-center text-gray-500 text-[9px]">Loading...</div>
    </div>
</div>

        <!-- MONITOR PAGE -->
        <div id="page-monitor" class="page">
            <div class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 rounded-xl p-3 mb-3">
                <h2 class="text-base font-black text-white">üìä System Monitor</h2>
                <p class="text-white/80 font-bold text-[9px]">Worker & system status</p>
            </div>
            <div id="system-status">
                <div class="p-3 text-center text-gray-500 text-[9px]">Loading...</div>
            </div>
        </div>
    </main>

    <script type="module">
    import { requestNotificationPermission } from './firebase-config.js';

    const API_BASE = window.location.origin;
        let selectedOrderId = null;

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            const btn = document.querySelector('[data-page="' + pageId + '"]');
            if (btn) btn.classList.add('active');

            // Load page-specific data
            if (pageId === 'verification') loadVerificationTasks();
            if (pageId === 'mapping') loadMappingTasks();
            if (pageId === 'monitor') loadSystemStatus();
        }
        window.showPage = showPage;

        // View order detail
        function viewOrder(orderId) {
            selectedOrderId = orderId;
            showPage('detail');
            renderOrderDetail(orderId);
        }
        window.viewOrder = viewOrder;
        // Push notifications
window.enablePushNotifications = async function() {
    document.getElementById('push-permission-popup').classList.add('hidden');
    await requestNotificationPermission();
};

window.dismissPushPermission = function() {
    document.getElementById('push-permission-popup').classList.add('hidden');
    localStorage.setItem('pushNotificationDismissed', 'true');
};

// Show push permission popup after 2 seconds
setTimeout(() => {
    const dismissed = localStorage.getItem('pushNotificationDismissed');
    if (Notification.permission === 'default' && !dismissed) {
        document.getElementById('push-permission-popup').classList.remove('hidden');
    } else if (Notification.permission === 'granted') {
        requestNotificationPermission();
    }
}, 2000);

        // Load system status
        async function loadStatus() {
            try {
                const resp = await fetch(`${API_BASE}/api/status`);
                const data = await resp.json();

                const indicator = document.getElementById('status-indicator');
                if (data.worker_online) {
                    indicator.innerHTML = `
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full pulse"></span>
                        <span class="font-black text-green-700 text-[8px]">ONLINE</span>
                    `;
                    indicator.className = 'flex items-center gap-1 bg-green-100 px-1.5 py-1 rounded-lg border border-green-400';
                } else {
                    indicator.innerHTML = `
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                        <span class="font-black text-red-700 text-[8px]">OFFLINE</span>
                    `;
                    indicator.className = 'flex items-center gap-1 bg-red-100 px-1.5 py-1 rounded-lg border border-red-400';
                }

                // Update verification badge
                const verifyBadge = document.getElementById('verify-badge');
                if (data.verification_count > 0) {
                    verifyBadge.textContent = data.verification_count;
                    verifyBadge.classList.remove('hidden');
                    verifyBadge.classList.add('flex');
                } else {
                    verifyBadge.classList.add('hidden');
                }

                // Update queue stat
                document.getElementById('stat-queue').textContent = data.queue_size;

            } catch (e) {
                console.error('Status error:', e);
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const resp = await fetch(`${API_BASE}/api/orders`);
                const data = await resp.json();

                const orders = data.orders || [];

                // Update stats
                document.getElementById('stat-total').textContent = orders.length;

                let completedCount = 0;
                orders.forEach(o => {
                    if (o.total_tasks > 0 && o.completed_tasks === o.total_tasks) {
                        completedCount++;
                    }
                });
                document.getElementById('stat-completed').textContent = completedCount;
                // Update mapping badge
let mappingCount = 0;
orders.forEach(o => {
    if (o.mapping_tasks > 0) mappingCount++;
});

const mappingBadge = document.getElementById('mapping-badge');
if (mappingCount > 0) {
    mappingBadge.textContent = mappingCount;
    mappingBadge.classList.remove('hidden');
    mappingBadge.classList.add('flex');
} else {
    mappingBadge.classList.add('hidden');
}

                // Render orders list
                const container = document.getElementById('orders-list');

                if (orders.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No orders yet</div>';
                    return;
                }

                container.innerHTML = orders.slice(0, 20).map(order => {
                    const statusColor = getStatusColor(order);
                    const statusText = getStatusText(order);

                    return `
                        <div class="p-3 flex items-center justify-between clickable" onclick="viewOrder(${order.id})">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                <div>
                                    <div class="font-black text-xs text-gray-800">#${order.shopify_order_number || order.id}</div>
                                    <div class="text-[9px] text-gray-400">${order.customer_name || 'Unknown'}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-right">
                                    <div class="text-[8px] text-gray-400">${order.completed_tasks || 0}/${order.total_tasks || 0}</div>
                                </div>
                                <span class="bg-${statusColor} text-white text-[8px] font-bold px-2 py-1 rounded-full whitespace-nowrap">${statusText}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Orders error:', e);
            }
        }

        function getStatusColor(order) {
            if (order.verification_tasks > 0) return 'orange-500';
            if (order.failed_tasks > 0) return 'red-500';
            if (order.mapping_tasks > 0) return 'yellow-500';
            if (order.completed_tasks === order.total_tasks && order.total_tasks > 0) return 'green-500';
            return 'blue-500';
        }

        function getStatusText(order) {
            if (order.verification_tasks > 0) return '‚ö†Ô∏è VERIFY';
            if (order.failed_tasks > 0) return '‚ùå FAILED';
            if (order.mapping_tasks > 0) return 'üó∫Ô∏è MAPPING';
            if (order.completed_tasks === order.total_tasks && order.total_tasks > 0) return '‚úÖ DONE';
            return '‚è≥ PROCESSING';
        }

        // Render order detail
        async function renderOrderDetail(orderId) {
            try {
                const resp = await fetch(`${API_BASE}/api/orders/${orderId}`);
                const data = await resp.json();
                const order = data.order;

                const container = document.getElementById('detail-content');

                if (!order) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8"><p class="text-sm">Order not found</p></div>';
                    return;
                }

                const shippingAddr = order.shipping_address ? JSON.parse(order.shipping_address) : {};

                container.innerHTML = `
                    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 rounded-xl p-3 mb-3">
                        <div class="text-white">
                            <h2 class="text-base font-black">üì¶ Order #${order.shopify_order_number || order.id}</h2>
                            <p class="text-white/80 font-bold text-[9px]">${new Date(order.created_at).toLocaleString()}</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border-2 border-green-400 p-3 mb-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-5 h-5 rounded bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center">
                                <span class="text-[8px]">üë§</span>
                            </div>
                            <span class="text-gray-700 font-black text-[10px]">Customer</span>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5">
                            <div class="bg-gray-50 rounded-lg p-1.5 border border-gray-200">
                                <div class="text-[7px] text-gray-400 font-black">NAME</div>
                                <div class="font-bold text-[10px] text-gray-800">${order.customer_name || 'N/A'}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-1.5 border border-gray-200">
                                <div class="text-[7px] text-gray-400 font-black">LOCATION</div>
                                <div class="font-bold text-[10px] text-gray-800">${shippingAddr.city || 'N/A'}, ${shippingAddr.province_code || ''}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border-2 border-purple-400 p-3 mb-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-5 h-5 rounded bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                                <span class="text-[8px]">üì¶</span>
                            </div>
                            <span class="text-gray-700 font-black text-[10px]">Line Items (${order.items.length})</span>
                        </div>
                        ${order.items.map(item => renderLineItem(item)).join('')}
                    </div>
                `;

            } catch (e) {
                console.error('Detail error:', e);
            }
        }

        function renderLineItem(item) {
            const stateColors = {
                'queued': 'blue',
                'processing': 'purple',
                'verification_required': 'orange',
                'needs_mapping': 'yellow',
                'purchased': 'green',
                'failed': 'red'
            };

            const stateIcons = {
                'queued': '‚è≥',
                'processing': '‚öôÔ∏è',
                'verification_required': '‚ö†Ô∏è',
                'needs_mapping': 'üó∫Ô∏è',
                'purchased': '‚úÖ',
                'failed': '‚ùå'
            };

            const color = stateColors[item.state] || 'gray';
            const icon = stateIcons[item.state] || '‚Ä¢';

            return `
                <div class="bg-gray-50 rounded-lg p-2 mb-2 border-l-4 border-${color}-500">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex-1 min-w-0">
                            <div class="font-black text-[10px] text-gray-800">${item.title || 'Unknown Product'}</div>
                            <div class="text-[8px] text-gray-400">SKU: ${item.sku || 'N/A'} ‚Ä¢ Qty: ${item.task_quantity || item.quantity}</div>
                        </div>
                        <span class="bg-${color}-500 text-white text-[7px] font-bold px-1.5 py-0.5 rounded-full ml-2">${icon} ${(item.state || 'unknown').toUpperCase()}</span>
                    </div>
                    ${item.amazon_url ? `
                        <a href="${item.amazon_url}" target="_blank" class="block mt-1 bg-orange-500 text-white text-center text-[8px] font-bold py-1 rounded">
                            üõí Open on Amazon
                        </a>
                    ` : ''}
                    ${item.error_message ? `
                        <div class="mt-1 text-[8px] text-red-600">${item.error_message}</div>
                    ` : ''}
                </div>
            `;
        }

        // Load verification tasks
        async function loadVerificationTasks() {
            try {
                const resp = await fetch(`${API_BASE}/api/tasks/verification-required`);
                const data = await resp.json();

                const container = document.getElementById('verification-list');
                const tasks = data.tasks || [];

                if (tasks.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-xl border-2 border-green-400 p-4 text-center">
                            <div class="text-green-600 font-bold text-sm">‚úÖ No verification needed</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = tasks.map(task => `
                    <div class="bg-white rounded-xl border-2 border-orange-400 p-3 mb-2">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-black text-xs text-gray-800">Task #${task.id}</span>
                            <span class="bg-orange-500 text-white text-[7px] font-bold px-1.5 py-0.5 rounded-full">‚ö†Ô∏è VERIFY</span>
                        </div>
                        <div class="text-[9px] text-gray-600 mb-1">Order: #${task.shopify_order_number}</div>
                        <div class="text-[9px] text-gray-600 mb-2">Product: ${task.product_name || task.asin}</div>
                        <div class="text-[8px] text-orange-600 mb-2">${task.error_message || 'Manual verification required'}</div>
                        <a href="https://www.amazon.com/ap/signin" target="_blank" class="block bg-gradient-to-r from-orange-500 to-red-500 text-white text-center text-[9px] font-bold py-1.5 rounded-lg">
                            üîê Go to Amazon Login
                        </a>
                        <div class="mt-2 text-[8px] text-gray-500">
                            ‚ÑπÔ∏è After logging in, the worker will resume automatically
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Verification error:', e);
            }
        }
        // Load mapping tasks
async function loadMappingTasks() {
    try {
        const resp = await fetch(`${API_BASE}/api/tasks/needs-mapping`);
        const data = await resp.json();

        const container = document.getElementById('mapping-list');
        const tasks = data.tasks || [];

        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-xl border-2 border-green-400 p-4 text-center">
                    <div class="text-green-600 font-bold text-sm">‚úÖ All products mapped</div>
                </div>
            `;
            return;
        }

        container.innerHTML = tasks.map(task => `
            <div class="bg-white rounded-xl border-2 border-yellow-400 p-3 mb-2">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-black text-xs text-gray-800">Task #${task.id}</span>
                    <span class="bg-yellow-500 text-white text-[7px] font-bold px-1.5 py-0.5 rounded-full">üó∫Ô∏è MAPPING</span>
                </div>
                <div class="text-[9px] text-gray-600 mb-1">Order: #${task.shopify_order_number}</div>
                <div class="text-[9px] text-gray-600 mb-2">Product: ${task.product_name || 'Unknown'}</div>
                <div class="text-[9px] font-bold text-gray-800 mb-1">ASIN: ${task.asin || 'N/A'}</div>
                <div class="text-[8px] text-yellow-600 mb-2">${task.error_message || 'ASIN not in catalog'}</div>
                <div class="text-[8px] text-gray-500">Add this ASIN to products.json and re-import catalog</div>
            </div>
        `).join('');

    } catch (e) {
        console.error('Mapping error:', e);
    }
}

        // Load system status
        async function loadSystemStatus() {
            try {
                const resp = await fetch(`${API_BASE}/api/status`);
                const data = await resp.json();

                const container = document.getElementById('system-status');

                container.innerHTML = `
                    <div class="bg-white rounded-xl border-2 border-${data.worker_online ? 'green' : 'red'}-400 p-3 mb-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-${data.worker_online ? 'green' : 'red'}-500 rounded-full ${data.worker_online ? 'pulse' : ''}"></div>
                            <span class="font-black text-xs">Worker: ${data.worker_online ? 'Online ‚úÖ' : 'Offline ‚ùå'}</span>
                        </div>
                        ${data.last_heartbeat_at ? `
                            <div class="text-[9px] text-gray-500">Last heartbeat: ${new Date(data.last_heartbeat_at).toLocaleString()}</div>
                        ` : ''}
                        ${data.last_action ? `
                            <div class="text-[9px] text-gray-600 mt-1">Last action: ${data.last_action}</div>
                        ` : ''}
                    </div>

                    <div class="bg-white rounded-xl border-2 border-blue-400 p-3">
                        <div class="font-black text-xs mb-2">üìä Queue Status</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-blue-50 rounded p-2 text-center">
                                <div class="text-[8px] text-blue-600 font-black">QUEUED</div>
                                <div class="text-lg font-black text-blue-600">${data.queue_size}</div>
                            </div>
                            <div class="bg-orange-50 rounded p-2 text-center">
                                <div class="text-[8px] text-orange-600 font-black">VERIFY</div>
                                <div class="text-lg font-black text-orange-600">${data.verification_count || 0}</div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (e) {
                console.error('System status error:', e);
            }
        }

        // Refresh all data
        async function refreshData() {
            await Promise.all([
                loadStatus(),
                loadOrders()
            ]);
        }
        window.refreshData = refreshData;

        // Initial load
        refreshData();

        // Auto-refresh every 10 seconds
        setInterval(refreshData, 10000);

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(e => console.log('SW registration failed:', e));
        }
    </script>
</body>
</html>
